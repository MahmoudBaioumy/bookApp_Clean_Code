import 'package:flustra_template/core/common/error_handler/failure.dart';
import 'package:flustra_template/core/services/bot_toast/app_bot_toast.dart';
import 'package:flustra_template/modules/Wishist/logic/fav_cubit.dart';
import 'package:flustra_template/modules/best_seller/logic/best_seller_cubit.dart';
import 'package:flustra_template/modules/cart/data/request/cart_request.dart';
import 'package:flustra_template/modules/cart/logic/cart_cubit.dart';
import 'package:flutter/material.dart';

class BestSellerBooksDetailsController extends ChangeNotifier {
  // ========================== Constructor ==========================
  BestSellerBooksDetailsController();

  final bestSellerCubit _bestSellerCubit = bestSellerCubit.i;
  List<int> favoriteBookIds = [];
  // ========================== ğŸ”’ Private variables ğŸ”’ ==========================

  // ========================== ğŸ—ï¸ Public variables ğŸ—ï¸ ==========================

  // ========================== ğŸ”¥ initialization ğŸ”¥ ==========================
  Future<void> init() async {}

// ========================== ğŸŒ Public methods and events ğŸŒ ==========================

// ========================== ğŸ”’ Private methods ğŸ”’ ==========================

  // ========================== ğŸ”¥ onTapFavourite ğŸ”¥ ========================== //

  Future<void> onTapFavourite(int bookId) async {
    final res = await WishlistCubit.i.addToWishlist(bookId: bookId);
    res.fold(
          (failure) => failure.showToast(),
          (r) {
        AppBotToast.show("Added to wishlist Success", type: ToastType.success);

        // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ favoriteBookIds Ø­Ø³Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        if (!favoriteBookIds.contains(bookId)) {
          favoriteBookIds.add(bookId);
        }
        notifyListeners();
      },
    );
  }

  Future<void> loadFavoriteBooks() async {
    final res = await WishlistCubit.i.getWishlist(); // Ø¨ÙŠØ±Ø¬Ø¹ Either<Failure, addWishlistResponse>

    res.fold(
          (failure) {
        failure.showToast();
        favoriteBookIds = [];
      },
          (wishlistResponse) {
        // wishlistResponse.data.data Ù‡Ù†Ø§ Ù‚Ø§Ø¦Ù…Ø© ÙƒØªØ¨ Ø§Ù„Ù…ÙØ¶Ù„Ø©
        favoriteBookIds = wishlistResponse.data
            ?.map((bookData) => bookData.id ?? 0) // Ø§Ø³ØªØ®Ø¯Ù… field Ø§Ù„ØµØ­ Ù„Ù„Ù€ id
            .toList() ??
            [];
      },
    );

    notifyListeners();
  }
  Future<void> toggleFavourite(int bookId) async {
    if (favoriteBookIds.contains(bookId)) {
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø³Ø­
      try {
        final res = await WishlistCubit.i.removeFromWishlist(bookId: bookId);
        res.fold(
              (failure) => failure.showToast(), // ÙØ´Ù„ â†’ ÙŠÙØ¶Ù„ Ø§Ù„Ù‚Ù„Ø¨ Ø£Ø­Ù…Ø±
              (r) {
            AppBotToast.show("Removed from wishlist", type: ToastType.success);
            favoriteBookIds.remove(bookId); // Ù†Ø¬Ø­ â†’ Ù†Ø´ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨
            notifyListeners();
          },
        );
      } catch (e) {
        // Ø£ÙŠ Ø®Ø·Ø£ â†’ Ø§Ù„Ù‚Ù„Ø¨ ÙŠÙØ¶Ù„ Ø£Ø­Ù…Ø±
      }
    } else {
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ©
      try {
        final res = await WishlistCubit.i.addToWishlist(bookId: bookId);
        res.fold(
              (failure) => failure.showToast(), // ÙØ´Ù„ â†’ Ù„Ø§ ØªØºÙŠÙŠØ±
              (r) {
            AppBotToast.show("Added to wishlist", type: ToastType.success);
            favoriteBookIds.add(bookId); // Ù†Ø¬Ø­ â†’ Ù†Ø¶ÙŠÙ Ø§Ù„ÙƒØªØ§Ø¨
            notifyListeners();
          },
        );
      } catch (e) {}
    }
  }



// ========================== ğŸ”¥ onTapCart ğŸ”¥ ========================== //

  Future<void> onTapCart(int bookId) async {
    final res = await CartCubit.i.addToCart(request: AddToCartRequest(productId: bookId, quantity: 1));
    res.fold(
      (failure) => failure.showToast(),
      (cart) => AppBotToast.show(" add to cart Success total: ${cart.data?.total}"),
    );
  }

}
